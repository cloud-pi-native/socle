# TODO variabilize openshift boolean
openshift:
  enabled: true
config:
  secret:
    argocdServerAdminPassword: "{{ dsc.argocd.admin.password }}"
{% if dsc.exposedCA != 'none' %}
  tlsCerts:
    {{ gitlab_domain }}: |
      {{ exposed_ca_pem | indent(width=6, first=False) }}
{% endif %}
dex:
  enabled: true
server:
  insecure: true
  config:
    clusterResources: "true"
    url: "https://{{ argocd_domain }}/"
    oidc.config: |
      issuer: https://{{ keycloak_domain }}/auth/realms/dso
      requestedScopes: ["openid", "generic"]
      name: Keycloak
      clientID: {{ argocd_secret.resources[0].data.CLIENT_ID | b64decode }}
      clientSecret: {{ argocd_secret.resources[0].data.CLIENT_SECRET | b64decode }}
{% if dsc.exposedCA != 'none' %}
      rootCA: |
        {{ exposed_ca_pem | indent(width=8, first=False) }}
{% endif %}
    users.anonymous.enabled: "false"
    admin.enabled: "false" # TODO variabilize
    kustomize.buildOptions: '{{dsc.argocd.kustomize_buildOptions}}'
    resource.exclusions: |
      - apiGroups:
        - tekton.dev
        clusters:
        - '*'
        kinds:
        - TaskRun
        - PipelineRun
  extraEnvVars:
{% if dsc.proxy.enabled %}
    - name: HTTP_PROXY
      value: "{{ dsc.proxy.http_proxy }}"
    - name: HTTPS_PROXY
      value: "{{ dsc.proxy.https_proxy }}"
    - name: NO_PROXY
      value: "{{ dsc.proxy.no_proxy }},argo-argo-cd-repo-server"
{% endif %}
repoServer:
  extraEnvVars:
{% if dsc.proxy.enabled %}
    - name: HTTP_PROXY
      value: "{{ dsc.proxy.http_proxy }}"
    - name: HTTPS_PROXY
      value: "{{ dsc.proxy.https_proxy }}"
    - name: NO_PROXY
      value: "{{ dsc.proxy.no_proxy }}"
{% endif %}
extraDeploy:
  - apiVersion: v1
    data:
      policy.csv: |
        p, role:admin, *, *, */*, allow
        p, role:nada, *, *, */*, deny
        g, system:cluster-admins, role:admin
        g, cluster-admins, role:admin
        g, /ArgoCDAdmins, role:admin
        g, ArgoCDAdmins, role:admin
      scopes: "[groups]"
      policy.default: role:nada
      admin.enabled: "false"
    kind: ConfigMap
    metadata:
      name: argocd-rbac-cm
      namespace: {{ dsc.argocd.namespace }}